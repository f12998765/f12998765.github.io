<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.18.1" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="alternate" href="https://www.xizero.com//index.xml" type="application/rss+xml" title="XIZERO">
<link href="https://www.xizero.com/css/tomorrow.min.css" rel="stylesheet">
<link href="https://www.xizero.com//css/main.css" rel="stylesheet">
<link href="https://www.xizero.com/css/jqcloud.css" rel="stylesheet">
<script src="https://www.xizero.com/js/high.min.js"></script>
<script src="https://www.xizero.com/js/jqury.min.js"></script>
<script src="https://www.xizero.com/js/top.js"></script>
<script src="https://www.xizero.com/js/jqcloud.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<title>一个想法 - XIZERO</title>
</head>
<body>

<div id="gotop" title="🚀 go top"></div>

<div class="top">

	<div class="gos">
		<span class="go"><a href="/">Home</a></span>
		<span class="go"><a href="/tags/">Tags</a></span>
		<span class="go"><a href="/about/">About</a></span>
	</div>
	
	
		<div class="tit">
			一个想法
		</div>

	

</div>




<div class="con">
	<p>自己做了一个小东西，一个简单的 <a href="http://hao.xizero.com">网址索引</a>。</p>

<p>因为要显示每个网站的favicon，google一下，找到了一些还能用公共的api。</p>

<ul>
<li><p>google：<a href="http://www.google.com/s2/favicons?domain=">http://www.google.com/s2/favicons?domain=</a></p></li>

<li><p>BYI_API：<a href="https://api.byi.pw/favicon/">https://api.byi.pw/favicon/</a></p></li>
</ul>

<p>其他的都不能用了，谷歌还要翻墙，最后就用了BYI_API。</p>

<p>一直都挺好的，被墙的网站也能返回，直到前几天（估计在11月12日左右），崩了（&gt;_&lt;）。</p>

<p>面对满页的XX，我换了另一个。</p>

<ul>
<li><a href="http://f.ydr.me/?url=">http://f.ydr.me/?url=</a></li>
</ul>

<p>但是，满页的ie图标是要干啥（不支持的被墙的网站）</p>

<p>后来，看到了一个问答，大概是通过判断图片的MD5来判断是不是小地球（获取失败时返回），我灵感一动，两天的折磨……</p>

<p>前段框架用的是刚学的vue.js 2，用过滤器 filters 不就可以了吗？</p>

<pre><code class="language-js">
{{data_url  | filter}}
</code></pre>

<p>只要我把前面的链接获取到，然后判断那个图标是不是小地球，再来调用其他的api，不就可以了吗。</p>

<p>但是 vue 不支持在绑定属性中使用过滤器，（&gt;_&lt;），好，再google，(⊙o⊙)哦，要用计算属性 computed 啊！？</p>

<p>但是计算属性不能传参，（&gt;_&lt;），好，只能再找了，可以用 methods 。</p>

<p>之前学习了fetch，用fetch下图标，然后直接返回图片，这儿遇到点问题，主要是图片的处理和到最后也没有解决的跨域问题。</p>

<pre><code class="language-js">
fetch(img_url)
.then(function(res){
    return res.blob();
})
.then(function(imageBlob){
    img_src = window.URL.createObjectURL(imageBlob);
    //more
})
</code></pre>

<p>这是一个简单的fetch获取图片的例子，复刻官网上的，本地图片可以加载。</p>

<p>但是favicon api是不支持跨域请求，所以一直在做挣扎。</p>

<p>在这段时间之中，把这个方法放到了mounted，想让图片直接在加载时判断。</p>

<p>主要是因为好好的看了一下js的闭包，之前有过卡在这儿的经历，还好征服了。</p>

<pre><code class="language-js">
for(var i=0;i&lt;json.length;i++){
    (function(i){
        for(var j=0;j&lt;json[i].list.length;j++){
            (function(j){
                fetch(
                'https://s2.googleusercontent.com/s2/favicons?domain='
                +json[i].list[j].url,
                    {
                        mode:&quot;cors&quot;,
                        headers:{
                        'Access-Control-Allow-Origin':'*'
                        }
                    }
                )
                .then(function(res){
                    return res.blob();
                })
                .then(function(imageBlob){
                    json[i].list[j].img
                    =window.URL.createObjectURL(imageBlob);
                })
            })(j);
        }
    })(i);
}

</code></pre>

<p>痛苦的是解决fetch 的跨域问题</p>

<p>fetch 的response 中有个mode的属性，可取值4个，包括 cors、no-cors等。</p>

<p>默认为cors，但在请求图片时，浏览器会提醒跨域问题。
当设置为 no-cors 时， 虽然不会报错，但是你并不能获取resquest 中的data，所以然并软。</p>

<p>还曾引入过fetch-jsonp.js，但是就像no-cors，获取不到内容。</p>

<p>设置请求头中的Access-Control-Allow-Origin，会提示服务器不支持。</p>

<p>就当我要放弃时，我又突发奇想，等网页加载完，判断下载本地的图片。</p>

<p>不能直接获取图片的MD5，找到了别人写的代码，先变成Base64.</p>

<pre><code class="language-js">
function getBase64Image(img) {
    var canvas = document.createElement(&quot;canvas&quot;);
    canvas.width = img.width;
    canvas.height = img.height;

    var ctx = canvas.getContext(&quot;2d&quot;);
    ctx.drawImage(img, 0, 0, img.width, img.height);

    var dataURL = canvas.toDataURL(&quot;image/png&quot;);
    return dataURL

    // return dataURL.replace(&quot;data:image/png;base64,&quot;, &quot;&quot;);
}

</code></pre>

<p>接下来，用SparkMD5，讲Base64编码，再比较。</p>

<p>小心翼翼地试了下，好像可以。</p>

<p>但是，当我写好了代码，请求时，浏览器报错传到函数里面的不是一个HTMLElement。
我想是不是因为图片还没有加载完成，获取不到节点，那就判断一下。</p>

<pre><code class="language-js">
if (img.complete) {}
</code></pre>

<p>但是，<strong>canvas</strong> 不支持跨域 ！</p>

<p>所以，我放弃了。</p>

<p>我又重新看了一下开始的API，好像能用了，那就切换回来好了。</p>

<p>看到他的代码开源，想要自己整一个,以防万一。</p>

<p>（&gt;_&lt;）为什么是 拍X片 PHP ？？？</p>

<p>结束</p>

<p>后记</p>

<p>当我兴致勃勃的去用java写一个api时，我卡在了线程同步……</p>

</div>


<div class="boo">
	<span></span>
</div>
<div class="footer">
	@XIZERO Powered by <a href="http://hugo.spf13.com/">Hugo</a> and <a href="#">bigbig</a>
</div>
</body>
</html>

