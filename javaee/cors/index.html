<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.18.1" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" href="http://hugo.xizero.com//index.xml" type="application/rss+xml" title="XIZERO">
<link href="http://hugo.xizero.com/css/block.css" rel="stylesheet">
<script src="http://hugo.xizero.com/js/jqury.min.js"></script>
<script src="http://hugo.xizero.com/js/top.js"></script>


<title>CORS - XIZERO</title>
</head>
<body>

<div id="gotop" title="🚀 go top"></div>


<div class="titlist">
	<span><a href="http://hugo.xizero.com/">Home</a></span>
	<span><a href="http://hugo.xizero.com//tags/">Tags</a></span>
	<span><a href="http://hugo.xizero.com//about">About</a></span>
</div>



<link href="http://hugo.xizero.com/css/context.css" rel="stylesheet">
<link href="http://hugo.xizero.com/css/tomorrow.min.css" rel="stylesheet">
<script src="http://hugo.xizero.com/js/high.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<div class="tit">
	CORS
</div>

<div class="toc">
	<nav id="TableOfContents">
<ul>
<li><a href="#cors">CORS</a>
<ul>
<li><a href="#关于跨域请求">关于跨域请求</a></li>
<li><a href="#cors-过程理解">CORS 过程理解</a></li>
<li><a href="#cors-请求">CORS 请求</a>
<ul>
<li><a href="#简单请求">简单请求</a></li>
<li><a href="#预请求">预请求</a></li>
</ul></li>
<li><a href="#http-请求头">HTTP 请求头</a>
<ul>
<li><a href="#origin">Origin</a></li>
<li><a href="#access-control-request-method">Access-Control-Request-Method</a></li>
<li><a href="#access-control-request-headers">Access-Control-Request-Headers</a></li>
</ul></li>
<li><a href="#http-响应头">HTTP 响应头</a>
<ul>
<li><a href="#access-control-allow-origin">Access-Control-Allow-Origin</a></li>
<li><a href="#access-control-expose-headers">Access-Control-Expose-Headers</a></li>
<li><a href="#access-control-max-age">Access-Control-Max-Age</a></li>
<li><a href="#access-control-allow-credentials">Access-Control-Allow-Credentials</a></li>
<li><a href="#access-control-allow-methods">Access-Control-Allow-Methods</a></li>
<li><a href="#access-control-allow-headers">Access-Control-Allow-Headers</a></li>
</ul></li>
<li><a href="#在服务器端支持-cors">在服务器端支持 CORS</a>
<ul>
<li><a href="#在-tomcat-中设置-cors">在 tomcat 中设置 CORS</a></li>
<li><a href="#在-nginx-中设置-cors">在 nginx 中设置 CORS</a></li>
<li><a href="#在-java-web-项目中自定义-cors-过滤器">在 java web 项目中自定义 CORS 过滤器</a></li>
</ul></li>
<li><a href="#参考">参考</a></li>
</ul></li>
</ul>
</nav>
</div>

<div class="con">
	

<h1 id="cors">CORS</h1>

<p>跨域资源共享 ，Cross-Origin Resource Sharing ，简称 CORS。</p>

<p>使用 XMLHttpRequest 对象和Fetch发起 HTTP 请求就必须遵守同源策略，CORS 是HTML5 的跨域解决方案。</p>

<p>了解更多，参阅：<a href="https://www.w3.org/TR/cors/">https://www.w3.org/TR/cors/</a></p>

<h2 id="关于跨域请求">关于跨域请求</h2>

<p>理解上，跨域请求不是被服务器拒绝，而是<strong>返回结果被浏览器拦截</strong>了，被拒绝的结果可以在浏览器的开发者工具中查看。</p>

<p>其它，有些浏览器不允许从HTTPS的域跨域访问HTTP，比如Chrome和Firefox，会在请求发出前拦截。</p>

<p>常用的跨域请求场景是：使用 XMLHttpRequest 或 Fetch发起跨站 HTTP 请求。</p>

<h2 id="cors-过程理解">CORS 过程理解</h2>

<p>首先明确，<strong>CORS 的关键是服务器</strong>。</p>

<p>最简单的过程：</p>

<ol>
<li>浏览器发送 CORS 请求，在 header 中添加一个 <code>Origin</code> 字段，其值为请求源（协议+地址+端口）</li>
<li>服务器响应，并在 header 中添加 <code>Access-Control-Allow-Origin</code> 字段</li>
<li>浏览器接收，判断 header 来确定是否拦截</li>
</ol>

<h2 id="cors-请求">CORS 请求</h2>

<p>浏览器将 CORS 请求分为两类，简单请求和预请求。</p>

<h3 id="简单请求">简单请求</h3>

<p>简单请求的定义：</p>

<ul>
<li>只使用 GET, HEAD 或者 POST 请求方法。</li>
<li>使用 POST  请求时，数据类型(Content-Type)只能是 application/x-www-form-urlencoded, multipart/form-data 或 text/plain中的一种。</li>
<li>不会使用自定义请求头</li>
</ul>

<p>简单请求的响应就是最简单的过程，通过使用 Origin 和 Access-Control-Allow-Origin 就可以完成最简单的跨站请求。</p>

<h3 id="预请求">预请求</h3>

<p>预请求就是非简单请求。</p>

<p>预请求的重点是必须发送一个 <code>OPTIONS</code> 请求，来确定是否支持 CORS。浏览器确认之后，才会发送正式请求。原因是会对服务器的数据造成破坏。</p>

<p><strong>请求过程：</strong></p>

<p>发送一个 <code>OPEIONS</code> 请求。一同发送的还包括三个请求头：</p>

<ul>
<li>Origin - 源地址</li>
<li>Access-Control-Request-Method - 跨域请求的 HTTP 方法列表</li>
<li>Access-Control-Request-Headers - 跨域请求将发送的自定义头信息</li>
</ul>

<p>服务器处理请求，返回响应。并且返回了相应的响应头：</p>

<ul>
<li>Access-Control-Allow-Origin</li>
<li>Access-Control-Allow-Methods</li>
<li>Access-Control-Allow-Headers</li>
<li>Access-Control-Allow-Credentials</li>
<li>Access-Control-Max-Age</li>
</ul>

<p>之后的正常请求，与简单请求相同。</p>

<h2 id="http-请求头">HTTP 请求头</h2>

<h3 id="origin">Origin</h3>

<p>请求的源地址，包含请求的协议，地址，以及端口</p>

<p>不限于 CORS 请求，普通请求也会携带</p>

<p>当 Origin 的值为 null 时，表示请求地址为本地</p>

<h3 id="access-control-request-method">Access-Control-Request-Method</h3>

<p>在发送预请求中携带</p>

<p>告诉服务器在正式请求时使用的 HTTP 方法</p>

<h3 id="access-control-request-headers">Access-Control-Request-Headers</h3>

<p>在发送预请求中携带</p>

<p>告诉服务器在正式请求时会携带的自定义头信息。</p>

<p>多个值，使用逗号分开</p>

<h2 id="http-响应头">HTTP 响应头</h2>

<h3 id="access-control-allow-origin">Access-Control-Allow-Origin</h3>

<p>服务器响应的响应</p>

<p>允许请求的 URL</p>

<p>当值为 <code>*</code> 时，接受任意地址的请求</p>

<h3 id="access-control-expose-headers">Access-Control-Expose-Headers</h3>

<p>允许请求的自定义头</p>

<h3 id="access-control-max-age">Access-Control-Max-Age</h3>

<p>预请求结果的有效期，在有效期内，发送非简单请求，不需要再发送预请求。</p>

<h3 id="access-control-allow-credentials">Access-Control-Allow-Credentials</h3>

<p>是否允许发送 Cookie和HTTP认证信息</p>

<p>首先，在请求中设置</p>

<pre><code class="language-js">xhr.withCredentials = true;
</code></pre>

<p>使得 Cookies 能随请求一同发送</p>

<p>服务器接收响应，在响应头中包含 <code>Access-Control-Allow-Credentials: true</code> 。</p>

<p>如果响应头中没有该字段，浏览器会把响应结果丢弃，保证信息安全。</p>

<p><strong>特别注意：</strong></p>

<p>发送 Cookie 时，必须指定允许请求的域名。</p>

<p>不能设置为</p>

<pre><code>Access-Control-Allow-Origin: * 
</code></pre>

<h3 id="access-control-allow-methods">Access-Control-Allow-Methods</h3>

<p>在预请求的响应中携带</p>

<p>在正式请求时可使用的 HTTP 方法</p>

<h3 id="access-control-allow-headers">Access-Control-Allow-Headers</h3>

<p>在预请求的响应中携带</p>

<p>在正式请求时可使用的自定义HTTP请求头</p>

<h2 id="在服务器端支持-cors">在服务器端支持 CORS</h2>

<p>相关信息，参阅 <a href="https://enable-cors.org/index.html">enable cross-origin resource sharing</a></p>

<h3 id="在-tomcat-中设置-cors">在 tomcat 中设置 CORS</h3>

<p>在项目的 web.xml 中添加过滤器：</p>

<pre><code class="language-xml">&lt;filter&gt;
  &lt;filter-name&gt;CorsFilter&lt;/filter-name&gt;
  &lt;filter-class&gt;org.apache.catalina.filters.CorsFilter&lt;/filter-class&gt;
&lt;/filter&gt;
&lt;filter-mapping&gt;
  &lt;filter-name&gt;CorsFilter&lt;/filter-name&gt;
  &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
</code></pre>

<p>更多参数，请看 <a href="http://tomcat.apache.org/tomcat-7.0-doc/config/filter.html#CORS_Filter">http://tomcat.apache.org/tomcat-7.0-doc/config/filter.html#CORS_Filter</a></p>

<h3 id="在-nginx-中设置-cors">在 nginx 中设置 CORS</h3>

<p>请直接参阅，<a href="https://enable-cors.org/server_nginx.html">https://enable-cors.org/server_nginx.html</a></p>

<h3 id="在-java-web-项目中自定义-cors-过滤器">在 java web 项目中自定义 CORS 过滤器</h3>

<p>一个简单的 CORS 过滤器</p>

<pre><code class="language-java">package com.x.filter;
import java.io.IOException;
import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletResponse;
import org.springframework.stereotype.Component;

@Component
public class SimpleCORSFilter implements Filter {

    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException {
        HttpServletResponse response = (HttpServletResponse) res;
        response.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);
        response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);
        response.setHeader(&quot;Access-Control-Allow-Methods&quot;, &quot;POST, GET, OPTIONS, DELETE&quot;);
        response.setHeader(&quot;Access-Control-Max-Age&quot;, &quot;3600&quot;);
        response.setHeader(&quot;Access-Control-Allow-Headers&quot;, &quot;Access-Control-Allow-Headers, Origin,Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Request-Headers,Authorization&quot;);
        chain.doFilter(req, res);
    }

    public void init(FilterConfig filterConfig) {}

    public void destroy() {}

}
</code></pre>

<p>记得在 web.xml 中配置</p>

<pre><code class="language-xml">  &lt;!--CORS 过滤器--&gt;
  &lt;filter&gt;
    &lt;filter-name&gt;CORSFilter&lt;/filter-name&gt;
    &lt;filter-class&gt;com.x.filter.SimpleCORSFilter&lt;/filter-class&gt;
  &lt;/filter&gt;
  &lt;filter-mapping&gt;
    &lt;filter-name&gt;CORSFilter&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
  &lt;/filter-mapping&gt;
</code></pre>

<h2 id="参考">参考</h2>

<ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS</a>。</li>
<li><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html">跨域资源共享 CORS 详解</a></li>
<li><a href="https://www.w3.org/TR/cors/">https://www.w3.org/TR/cors/</a></li>
</ul>

</div>

<link href="http://hugo.xizero.com/css/footer.css" rel="stylesheet">

<div class="footer">
	<div class="_hr"><span></span></div>
	@XIZERO Powered by <a href="http://hugo.spf13.com/">Hugo</a> and <a href="#">bigbig</a>
</div>

</body>
</html>

